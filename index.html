<!DOCTYPE html>
<html lang="en">
    <head>

        <meta charset="utf-8">
        <title>Conference Schedule</title>
        <script type="text/javascript" src="d3/d3.v3.js"></script>
        <link href='http://fonts.googleapis.com/css?family=Oxygen+Mono|Open+Sans:400,700' rel='stylesheet' type='text/css'>

        <style>
            body {
                font-family: 'Open Sans';
                font-size: 14pt;
            }

            @media print
            {
            table {page-break-before:always}
            body{
            margin: 0mm 0mm 0mm 0mm;
            }
            }
        </style>
    </head>

        
    <body>

        <div id="viz"></div>
        <script type="text/javascript">

        //Copyright (c) 2013 Rebecca W. Perry

        //Permission is hereby granted, free of charge, to any person obtaining a copy
        //of this software and associated documentation files (the "Software"), to deal
        //in the Software without restriction, including without limitation the rights
        //to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
        //copies of the Software, and to permit persons to whom the Software is
        //furnished to do so, subject to the following conditions:

        //The above copyright notice and this permission notice shall be included in
        //all copies or substantial portions of the Software.

        //THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
        //IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        //FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
        //AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
        //LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
        //OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
        //THE SOFTWARE.

        //TODO: sort sponsors into general interest and narrow subjects categories?
        //TODO: link to maps?
        //TODO: improve the printable form?

        //page title
        d3.select("body")
             .append("p")
             .style("text-align","left")
             .style("margin","50px 100px 20px 100px") //top, right, bottom, left
             .style("width","1210px")
             .style("font-size","18pt")
             .style("font-weight", "bold")
             .text("APS March Meeting 2014: Make your own itinerary");


        //intro text
        d3.select("body")
             .append("p")
             .style("text-align","justify")
             .style("margin","20px 20px 30px 100px") //top, right, bottom, left
             //.style("width","85%")
             .style("max-width","1370px")
             .style("line-height","115%")
             .html("This is an UNofficial,  <a href = \"https://github.com/RebeccaWPerry/conferenceSchedule\" target=\"_blank\"> open source</a>, representation of the main sessions from the official meeting schedule <a href = \"http://meetings.aps.org/Meeting/MAR14/APS_epitome\" target=\"_blank\"> available here</a>.  Each of these sessions is either <i>regular</i> with fifteen contributed 10-minute talks, <i>invited</i> with five 30-minute talks, or <i>focus</i> with a mix of invited and contributed talks.  At March Meeting, there are also poster sessions, vendor exhibitions, and special lunchtime and evening sessions not listed here.  </br></br>What are you waiting for?  Create your personalized itinerary for APS March Meeting!</br></br></br> 1. Mouse over a topic to highlight the sessions sponsored by that topical group <FONT style=\"COLOR: white; BACKGROUND-COLOR: rgb(120,120,120)\">(dark gray)</FONT>. </br></br>2. Click a topic to lock or unlock those sessions to the calendar <FONT style=\"COLOR: white; BACKGROUND-COLOR: rgb(31,120,180)\">(blue)</FONT>. </br></br>3. Mouse over a calendar square to get more information on that session. </br></br>4. Click a calendar square to add it to your personal itinerary at the bottom of the page <FONT style=\"COLOR: black; BACKGROUND-COLOR: rgb(178, 255, 255)\">(turquoise)</FONT>.</br></br>*** save as html or print to pdf/paper to save your itinerary ***") ;



        //main dataset about sessions
        //https://github.com/mbostock/d3/wiki/CSV
        //var datasetloaded =  d3.csv.parse("test_java.csv", function(){console.log('This')} );



d3.json("sessions.json", function(error, thisdata){
            var dataset = thisdata

        //rooms are a simple list of strings, from organize.py, print rooms
        var rooms = ['102', '103/105', '104', '106', '107', '108', '112/110', '201', '203', '205', '207', '301-303', '304', '401', '402', '403', '404', '405', '406', '407', '501', '502', '503', '504', '505-507', '601', '603', '605', '607', '702', '703', '704', '705/707', '706', '708-712', '709/711', 'FSB', 'FSB 1', 'FSB 4', 'MHB 1A', 'MHB 1A-1B', 'MHB 1B', 'MHB 1C', 'MHB 1D', 'MHB 1E', 'MHB 1F', 'MHB 2A-3A', 'MHB 2B-3B', 'MHB 2C', 'MHB 3C', 'MHB 4A', 'MHB 4B', 'MHB 4C', 'MHB 4D', 'MHB 4E', 'MHB 4F']



        var sponsors = [
            {name: 'American Physical Society', s: 'APS', isToggled: false, color: 0},
            {name: 'Committee on Minorities', s: 'COM', isToggled: false, color: 0},
            {name: 'Committee on the Status of Women in Physics', s: 'CSWP', isToggled: false, color: 0},
            {name: 'Atomic, Molecular & Optical Physics', s: 'DAMOP', isToggled: false, color: 0},
            {name: 'Biological Physics', s: 'DBIO', isToggled: false, color: 0},
            {name: 'Chemical Physics', s: 'DCP', isToggled: false, color: 0},
            {name: 'Computational Physics', s: 'DCOMP', isToggled: false, color: 0},
            {name: 'Condensed Matter Physics', s: 'DCMP', isToggled: false, color: 0},
            {name: 'Fluid Dynamics', s: 'DFD', isToggled: false, color: 0},
            {name: 'Laser Science', s: 'DLS', isToggled: false, color: 0},
            {name: 'Materials Physics', s: 'DMP', isToggled: false, color: 0},
            {name: 'Polymer Physics', s: 'DPOLY', isToggled: false, color: 0},
            {name: 'Education', s: 'FEd', isToggled: false, color: 0},
            {name: 'Graduate Student Affairs', s: 'FGSA', isToggled: false, color: 0},
            {name: 'History of Physics', s: 'FHP', isToggled: false, color: 0},
            {name: 'Industrial and Applied Physics', s: 'FIAP', isToggled: false, color: 0},
            {name: 'International Physics', s: 'FIP', isToggled: false, color: 0},
            {name: 'Outreach and Engaging the Public', s: 'FOEP', isToggled: false, color: 0},
            {name: 'Physics and Society', s: 'FPS', isToggled: false, color: 0},
            {name: 'Energy Research and Applications', s: 'GERA', isToggled: false, color: 0},
            {name: 'Instrument and Measurement Science', s: 'GIMS', isToggled: false, color: 0},
            {name: 'Magnetism', s: 'GMAG', isToggled: false, color: 0},
            {name: 'Physics of Climate', s: 'GPC', isToggled: false, color: 0},
            {name: 'Quantum Information', s: 'GQI', isToggled: false, color: 0},
            {name: 'Statistical and Nonlinear Physics', s: 'GSNP', isToggled: false, color: 0},
            {name: 'Shock Compression of Condensed Matter', s: 'GSCCM', isToggled: false, color: 0},
            {name: 'Society of Physics Students', s: 'SPS', isToggled: false, color: 0},
            {name: 'no sponsor', s: 'none', isToggled: false, color: 0},
            {name: 'regular', s: '', isToggled: false, color: 0},
            {name: 'invited', s: '', isToggled: false, color: 0},
            {name: 'focus', s: '', isToggled: false, color: 0}];

        var days = [
            {d:"M", isToggled: true},
            {d:"T", isToggled: true},
            {d:"W", isToggled: true},
            {d:"T", isToggled: true},
            {d:"F", isToggled: true}];

        var simpledays = ['M','Tu', 'W','Th','F'];

        var times = [
            {d: "M", t:"08:00", isToggled: true},
            {d: "M", t:"11:15", isToggled: true},
            {d: "M", t: "02:30", isToggled: true},
            {d: "Tu", t:"08:00",isToggled: true},
            {d: "Tu", t:"11:15",isToggled: true},
            {d: "Tu", t: "02:30",isToggled: true},
            {d: "W", t:"08:00",isToggled: true},
            {d: "W", t:"11:15",isToggled: true},
            {d: "W", t: "02:30",isToggled: true},
            {d: "Th", t:"08:00",isToggled: true},
            {d: "Th", t:"11:15",isToggled: true},
            {d: "Th", t: "02:30",isToggled: true},
            {d: "F", t:"08:00",isToggled: true},
            {d: "F", t:"11:15",isToggled: true}];

        var totalrooms = rooms.length

        //data to be displayed in table
        var dataset2 = [],
        tmpDataset = [],
        i, j;


        for (i = 0; i < 15; i++) { //rows
            for (j = 0, tmpDataset = []; j < 4; j++) { //columns
                if (j == 0 && i >0){
                    tmpDataset.push(times[i-1].d + ' ' + times[i-1].t);
                }
                else{
                    tmpDataset.push(" ");
                }
            }
            dataset2.push(tmpDataset);
        }
        dataset2[0][0] = "Itinerary"
        dataset2[0][1] = "Option 1"
        dataset2[0][2] = "Option 2"
        dataset2[0][3] = "Option 3"
        
        //calendar grid box width and height
        var bw = 20;
        var bh = 20;

        var color = "rgb(31,120,180)"; //blue
        var hovercolor = "rgb(120,120,120)";
        var lightgray = "rgb(240,240,240)"
        var medgray = "rgb(211,211,211)"
        var calendared = "rgb(178, 255, 255)"//turquoise

        var starfontsize = "20px";

        var r1 = 430 //vertical offset

        //margin around svg
        var margin = {top: 20, right: 10, bottom: 20, left: 100};

        //width and height of canvas
        var w = 1600 - margin.left - margin.right,
            h = r1+400 - margin.top - margin.bottom;


        //////////////////////////
        // Begin SVG
        //////////////////////////

        var svg = d3.select("body").append("svg")
            .attr("width", w + margin.left + margin.right)
            .attr("height", h + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        //refresh the color of the text label of the sponsors
        function refreshTextColor(){
            d3.selectAll(".sponsortext").attr("fill", function(d,i){
                if (d.isToggled){
                    return color;
                    }
                else{
                    return "black";
                    }
                })
            }

        //refresh the color of the sponsor squares
        function refreshSquareColor(){
            d3.selectAll(".sponsorsquare").attr("fill", function(d,i){
                if (d.isToggled){
                     return color;
                     }
                 else{
                     return medgray;
                     }
                 })
             }

        function refreshCalendarColor(){
               //revise colors of calendar squares
               d3.selectAll(".calendarsquares").attr("fill", function(d){

                    togglescore = 0 
                    daysindex = simpledays.indexOf(d.day)

                    //get the kind index (e.g. focus)
                    kindindex = -1 //set to -1 as warning flag
                    for(var i = 0, len = sponsors.length; i< len; i++) {
                        if (sponsors[i].name === d.kind) {
                              kindindex = i
                                  break;}}
                    if (sponsors[kindindex].isToggled){togglescore = togglescore+1;}

                    //get the sponsor indices of each calendar square
                    eachsponsor = (d.sponsor).split(" ")

                    for(var j = 0, len = eachsponsor.length; j< eachsponsor.length;j++)                        
                        {                
                        sponsorindex = -1 //set to -1 as warning flag TODO
                        for(var i = 0, len = sponsors.length; i< len; i++) {
                            if (sponsors[i].s == eachsponsor[j]) {
                                  sponsorindex = i
                                      break;}
                            }
                        if (sponsors[sponsorindex].isToggled){togglescore = togglescore +1;}
                        }

                        //doesn't go away with day toggle, but that's ok, should
                        //always show something that has been added to the itinerary
                        if(d.isToggled){
                        return calendared}

                        if (days[daysindex].isToggled){
                                if (togglescore>0){ 
                                    return color;
                                    }
                                else{ // if either the day or the sponsor are untoggled
                                    return medgray;
                                    }
                            }
                         else{ // if either the day or the sponsor are untoggled
                            return medgray;
                             }
                    ;} // ends outer function
                    )//closes att on d3.selectAll
            }

        ////////////////////////
        // Legend
        ////////////////////////

        var numpercol = 11; 
        var colspacing = 500;

        //COLOR BLOCKS FOR SPONSORS
        var key = svg.selectAll("rect.key")
                .data(sponsors)
                .enter()
           .append("rect")
           .attr("class","sponsorsquare")
           .style("cursor", "pointer")
           .attr("isToggled",true);

        key.attr("x", function(d, i){
                return (d3.round(i/numpercol-.5,0)*colspacing);
                })
            .attr("y", function(d, i){
                return i%numpercol*28;
                })
           .attr("width", bw)
           .attr("height", bh)
           .attr("fill", medgray) //all start as medium gray

           .on("click",function(d,i){
                if (!d.isToggled)
                {d.isToggled=true
                    d3.select(this).attr("fill", color)
                }
                else{
                d.isToggled = false
                    d3.select(this).attr("fill", medgray)
                }

                refreshCalendarColor()
                refreshTextColor()
            })

            .on("mouseenter", function(d){
                    thissponsor = d.s
                    thisSponsor = d

                    //deal with the hovered sponsor
                    d3.select(this).attr("fill", hovercolor)

                    //color matching text
                    d3.selectAll(".sponsortext").attr("fill", function(d,i){
                        if (d == thisSponsor){
                            return hovercolor;
                        }
                        else{

                    if (d.isToggled){
                        return color;
                        }
                    else{
                        return "black";
                        }
                        }
                    })

                   //color squares in calendar grid
                   d3.selectAll(".calendarsquares").attr("fill", function(d){

                        togglescore = 0 
                        hoverscore = 0

                        daysindex = simpledays.indexOf(d.day)

                        //get the kind index (e.g. focus)
                        kindindex = -1 //set to -1 as warning flag
                        for(var i = 0, len = sponsors.length; i< len; i++) {
                            if (sponsors[i].name === d.kind) {
                                  kindindex = i
                                      break;}}
                        if (sponsors[kindindex].isToggled){togglescore = togglescore+1;}
                        if (sponsors[kindindex] == thisSponsor){hoverscore = hoverscore+1;}

                        //get the sponsor indices of each calendar square
                        eachsponsor = (d.sponsor).split(" ")

                        for(var j = 0, len = eachsponsor.length; j< eachsponsor.length;j++)                        
                            {                
                            sponsorindex = -1 //set to -1 as warning flag
                            for(var i = 0, len = sponsors.length; i< len; i++) {
                                if (sponsors[i].s == eachsponsor[j]) {
                                      sponsorindex = i
                                          break;}
                                }
                            if (sponsors[sponsorindex].isToggled){togglescore = togglescore +1;}
                            if (sponsors[sponsorindex].s == thissponsor){
                                
                                hoverscore = hoverscore +1;}

                            }


                            //doesn't go away with day toggle, but that's ok, should
                            //always show something that has been added to the itinerary
                            if(d.isToggled){
                            return calendared}

                            if (days[daysindex].isToggled){
                                    if (hoverscore>0){
                                        return hovercolor}
                                    else if (togglescore>0){ 
                                        return color;
                                        }
                                    else{ // if either the day or the sponsor are untoggled
                                        return medgray;
                                        }
                                }

                             else{ // if either the day or the sponsor are untoggled
                                return medgray;
                                 }

                        ;} // ends outer function
                        )//closes att on d3.selectAll
                    ;}
                    )

            .on("mouseout",function(d){
                    //recolor, but don't effect the toggle state
                    if(d.isToggled){
                        d3.select(this).attr("fill", color)
                        ;}
                    else {
                        d3.select(this).attr("fill", medgray) //to unselected gray
                        ;}

                   refreshCalendarColor()
                   refreshTextColor()
                   })

            //special star character, legend
            svg.append("text")
                .attr("x", (d3.round((sponsors.length)/numpercol-.5,0)*colspacing))
                .attr("y", (sponsors.length-3)%numpercol*25+52-bw/2+21)
                .style("text.anchor", "left")
                .style("font-size", starfontsize)
                .attr("fill", "white")
                .style("pointer-events", "none")
                .style("cursor", "pointer")
                .text("\u2605") //star

            //special circle, legend
            svg.append("circle")
                .style("cursor", "pointer")
                .attr("fill", "white")
                .style("pointer-events", "none")
                .attr("r", 5)
                .attr("x", (d3.round((sponsors.length)/numpercol-.5,0)*colspacing))
                .attr("cx", (d3.round((sponsors.length-3)/numpercol-.5,0)*colspacing+bw/2))
                .attr("cy", (sponsors.length)%numpercol*25+42-58+25);


            //reset square
            svg.append("rect")
                .attr("class", "unselectsq")
                .attr("isToggled", false)
                .attr("fill", medgray)
                .attr("width", bw)
                .attr("height", bh)
                .attr("x", function(){(i = sponsors.length+1)
                    return (d3.round(i/numpercol-.5,0)*colspacing);})
                .attr("y", function(){i = (sponsors.length+1)
                    return (i%numpercol*25+6+25);})
                .on("mouseenter", function(d){
                        //deal with the hovered sponsor
                        d3.select(this).attr("fill", hovercolor)
                        //color matching square
                        d3.selectAll(".unselecttext").attr("fill", hovercolor)
                       tooltip.style("background-color", lightgray) //background
                       tooltip.html("Unselects topics from calendar, but leaves squares already added to itinerary.")
                       return tooltip.style("visibility","visible")
                            .style("top",(d3.event.pageY-10)+"px")
                            .style("left",(d3.event.pageX+10)+"px");

                        })
                .on("mousemove", function(){return tooltip
                    .style("top",(d3.event.pageY-10)+"px")
                    .style("left",(d3.event.pageX+10)+"px");})

                .on("mouseout", function(d){
                        //deal with the hovered sponsor
                        d3.select(this).attr("fill", medgray)
                        //color matching square
                        d3.selectAll(".unselecttext").attr("fill", "black")
                        return tooltip.style("visibility", "hidden");})
                        
                .on("click", function(){

                    for(var i = 0, len = sponsors.length; i< len; i++) {
                        sponsors[i].isToggled = false
                        }

                        //deal with the hovered sponsor
                        d3.select(this).attr("fill", medgray)
                        //color matching square
                        d3.selectAll(".unselecttext").attr("fill", "black")

                        refreshSquareColor()
                        refreshTextColor()
                        refreshCalendarColor()
                     })

                //reset square, text
                svg.append("text")
                    .attr("class", "unselecttext")
                    .attr("fill", "black")
                    .attr("font-size","18px")
                    .attr("font-family", "Open Sans")
                    .style("cursor", "pointer")
                    .attr("x", function(){i = sponsors.length+1
                        return (d3.round(i/numpercol-.5,0)*colspacing+25);
                        })
                    .attr("y", function(){i = sponsors.length+1
                        return i%numpercol*25+22+27;
                        })
                    .text("Unselect all")
                .on("mouseenter", function(d){
                        //deal with the hovered sponsor
                        d3.select(this).attr("fill", hovercolor)
                        //color matching square
                        d3.selectAll(".unselectsq").attr("fill", hovercolor)
                       tooltip.style("background-color", lightgray) //background
                       tooltip.html("Deselects topics from calendar, but leaves squares added to itinerary.")
                       return tooltip.style("visibility","visible")
                            .style("top",(d3.event.pageY-10)+"px")
                            .style("left",(d3.event.pageX+10)+"px");

                        })
                .on("mousemove", function(){return tooltip
                    .style("top",(d3.event.pageY-10)+"px")
                    .style("left",(d3.event.pageX+10)+"px");})

                .on("mouseout", function(d){

                        //deal with the hovered sponsor
                        d3.select(this).attr("fill", "black")

                        //color matching square
                        d3.selectAll(".unselectsq").attr("fill", medgray)
                        return tooltip.style("visibility", "hidden");})

                .on("click", function(){

                    for(var i = 0, len = sponsors.length; i< len; i++) {
                        sponsors[i].isToggled = false
                        }

                    //deal with the hovered sponsor
                    d3.select(this).attr("fill", "black")

                    //color matching square
                    d3.selectAll(".unselectsq").attr("fill", medgray)

                    refreshSquareColor()
                    refreshTextColor()
                    refreshCalendarColor()}
                    )

            //sponsors, text
            svg.selectAll("text.sponsors")
                    .data(sponsors)
                    .enter()
                .append("text")
                .attr("class", "sponsortext")
                .style("text.anchor", "left")
                .style("font-size", "18px")
                .style("font-family", "Open Sans")
                .attr("fill", "black")
                .style("cursor", "pointer")
                .attr("x", function(d, i){
                    return (d3.round(i/numpercol-.5,0)*colspacing+25);
                    })
                .attr("y", function(d, i){
                    return i%numpercol*28+18;
                    })

                .text(function(d){
                    if (d.s == ""){
                        return d.name;} //just name for focus, regular, and invited
                    else{
                        return (d.s +": "+ d.name);} })//division abbreviation too



            .on("mouseenter", function(d){

                    thissponsor = d.s
                    thisSponsor = d

                    //deal with the hovered sponsor
                    d3.select(this).attr("fill", hovercolor)

                    //color matching square
                    d3.selectAll(".sponsorsquare").attr("fill", function(d,i){
                        if (d == thisSponsor){
                            return hovercolor;
                        }
                        else{
                            if (d.isToggled){
                                return color;
                                }
                            else{
                                return medgray;
                                }
                                }
                    })

                    //calendar squares
                   d3.selectAll(".calendarsquares").attr("fill", function(d){

                        togglescore = 0 
                        hoverscore = 0

                        daysindex = simpledays.indexOf(d.day)

                        //get the kind index (e.g. focus)
                        kindindex = -1 //set to -1 as warning flag
                        for(var i = 0, len = sponsors.length; i< len; i++) {
                            if (sponsors[i].name === d.kind) {
                                  kindindex = i
                                      break;}}
                        if (sponsors[kindindex].isToggled){togglescore = togglescore+1;}
                        if (sponsors[kindindex] == thisSponsor){hoverscore = hoverscore+1;}

                        //get the sponsor indices of each calendar square
                        eachsponsor = (d.sponsor).split(" ")

                        for(var j = 0, len = eachsponsor.length; j< eachsponsor.length;j++)                        
                            {
                            sponsorindex = -1 //set to -1 as warning flag
                            for(var i = 0, len = sponsors.length; i< len; i++) {
                                //console.log(sponsors[i].s) 
                                if (sponsors[i].s == eachsponsor[j]) {
                                      sponsorindex = i
                                          break;}
                                }
                            if (sponsors[sponsorindex].isToggled){togglescore = togglescore +1;}
                            if (sponsors[sponsorindex] == thisSponsor){
                                hoverscore = hoverscore +1 ;}
                            }

                            //doesn't go away with day toggle, but that's ok, should
                            //always show something that has been added to the itinerary
                            if(d.isToggled){
                            return calendared}

                            if (days[daysindex].isToggled){
                                    if (hoverscore==1){
                                        return hovercolor}
                                    else if (togglescore>0){ 
                                        return color;
                                        }
                                    else{ // if either the day or the sponsor are untoggled
                                        return medgray;
                                        }
                                }
                             else{ // if either the day or the sponsor are untoggled
                                return medgray;
                                }
                        ;} // ends outer function
                        )//closes att on d3.selectAll
                    ;}
                    )

            .on("mouseout",function(d, i){
                    //recolor, but don't effect the toggle state
                    if(d.isToggled){
                        d3.select(this).attr("fill", color)
                        ;}
                    else {
                        d3.select(this).attr("fill", "black") //to unselected gray
                        ;}
                    refreshCalendarColor()
                    refreshSquareColor()
                    }
                )

            .on("click",function(d,i){
                if (!d.isToggled)
                {d.isToggled=true
                 d3.select(this).attr("fill", color)
                }
                else{
                        d.isToggled = false
                        d3.select(this).attr("fill", "black") //to unselected black
                        }
                   refreshCalendarColor()
                   refreshSquareColor()
                })

        //////////////////////
        // Main calendar
        //////////////////////

        //calendar squares for each session
        var squares = svg.selectAll("rect.main")
                .data(dataset) //dataset is just numbers
                .enter()
            .append("rect")
            .attr("class", "calendarsquares")
            .attr("isToggled", true)
            .style("cursor", "pointer")

        var tooltip = d3.select("body")
            .append("div")
            .style("position", "absolute")
            .style("z-index", "10")
            .style("font-size", "20px")
            .style("font-family", "Open Sans")
            .style("font-weight", "bold")
            .style("color","black") //text color
            .style("background-color", lightgray) //background color
            .style("opacity", 0.75)
            .style("visibility", "hidden");

        squares.attr("x", function(d){ //placement based on room
                roomindex = rooms.indexOf(d.room)
                return 135+22*roomindex;})
            .attr("y", function(d){
                //day contribution (aligned with bottom of day label in svg)
                if(d.day=="M"){offset = r1+2*bh}
                else if(d.day == "Tu"){offset = r1+5*bh+10}
                else if(d.day == "W"){offset = r1+8*bh+20}
                else if(d.day == "Th"){offset = r1+11*bh+30}
                else {offset = r1+14*bh+40}

                //time contribution (upwards from 2:30)
                if(d.time==8){detail = 2*bh}
                else if(d.time==11){detail = bh}
                else{detail = 0}
                return offset-detail;})
           .attr("width", bw)
           .attr("height", bh)
           .attr("fill", medgray) //just start all gray
           .on("click", function(d){
                if (d.isToggled){
                    d.isToggled = false
                    refreshCalendarColor()}
                else {
                    d.isToggled = true
                    d3.select(this).attr("fill", calendared)
                    }

                    var itin = [
                            'Itinerary', 'Option 1', 'Option 2', 'Option 3',
                            "M 08:00", "", "", "",
                            "M 11:15", "", "", "",
                            "M 02:30", "", "", "",
                            "Tu 08:00", "", "", "",
                            "Tu 11:15", "", "", "",
                            "Tu 02:30", "", "", "",
                            "W 08:00", "", "", "",
                            "W 11:15", "", "", "",
                            "W 02:30", "", "", "",
                            "Th 08:00", "", "", "",
                            "Th 11:15", "", "", "",
                            "Th 02:30", "", "", "",
                            "F 08:00", "", "", "",
                            "F 11:15", "", "", ""]

                        //sort the toggled calendar squares into slots
                        var timeslotcounter = [-1,-1,-1,
                                               -1,-1,-1,
                                               -1,-1,-1,
                                               -1,-1,-1,
                                               -1,-1]

                        for(var i = 0, len = dataset.length; i< len; i++) {
                            if (dataset[i].isToggled){

                                if (dataset[i].time == 8){timeindex = 0}
                                if (dataset[i].time == 11){timeindex = 1}
                                if (dataset[i].time == 2) {timeindex = 2}

                                daysindex = simpledays.indexOf(dataset[i].day)
                                timeslotcounter[daysindex*3+timeindex] = 
                                    timeslotcounter[daysindex*3+timeindex]+1

                                //if there are 3 or fewer sessions selected for timeslot
                                if (timeslotcounter[daysindex*3+timeindex]<3)
                                    {

                                    scheduleLoc = 5+12*daysindex+4*timeindex+
                                        timeslotcounter[daysindex*3+timeindex]

                                    if (dataset[i].kind == "focus"){
                                        var kindofsession = 'Focus '}
                                    if (dataset[i].kind == "invited"){
                                        var kindofsession = 'Invited '}
                                    if (dataset[i].kind == "regular"){
                                        var kindofsession = ' '}

                                    itin[scheduleLoc] = dataset[i].title+
                                       "</br>Room: "+dataset[i].room+
                                        "</br>Sponsor: "+ dataset[i].sponsor+"</br>"+
                                        "<a href = \"http://meetings.aps.org/Meeting/MAR14/Session/"+dataset[i].code+"\"target=\"_blank\">"+ kindofsession +"Session: " +dataset[i].code+"</a>"
                                    }
                                 else { //too many selected for one timeslot
                                    d.isToggled = false
                                    //display warning
                                    tooltip.style("background-color","yellow") //background color
                                    tooltip.html("You have already added three sessions to your itinerary for this time slot. Remove another one to be able to add this one.")

                                 timeslotcounter = [-1,-1,-1,
                                               -1,-1,-1,
                                               -1,-1,-1,
                                               -1,-1,-1,
                                               -1,-1]

                        for(var i = 0, len = dataset.length; i< len; i++) {
                            if (dataset[i].isToggled){

                                if (dataset[i].time == 8){timeindex = 0}
                                if (dataset[i].time == 11){timeindex = 1}
                                if (dataset[i].time == 2) {timeindex = 2}

                                daysindex = simpledays.indexOf(dataset[i].day)
                                timeslotcounter[daysindex*3+timeindex] = 
                                    timeslotcounter[daysindex*3+timeindex]+1

                                //if there are 3 or fewer sessions selected for timeslot
                                if (timeslotcounter[daysindex*3+timeindex]<3)
                                {

                                    scheduleLoc = 5+12*daysindex+4*timeindex+
                                        timeslotcounter[daysindex*3+timeindex]

                                    if (dataset[i].kind == "focus"){
                                        var kindofsession = 'Focus '}
                                    if (dataset[i].kind == "invited"){
                                        var kindofsession = 'Invited '}
                                    if (dataset[i].kind == "regular"){
                                        var kindofsession = ' '}

                                    itin[scheduleLoc] = dataset[i].title+
                                       "</br>Room: "+dataset[i].room+
                                        "</br>Sponsor: "+ dataset[i].sponsor+"</br>"+
                                        "<a href = \"http://meetings.aps.org/Meeting/MAR14/Session/"+dataset[i].code+"\"target=\"_blank\">"+ kindofsession +"Session: " +dataset[i].code+"</a>"
                                    }}}

                                    refreshCalendarColor()
                                 }
                            }
                        ;} // ends outer function

                    //update the text showing in the table
                    d3.selectAll("td").html(function(d, i){return itin[i]})
                    }
                )

           .on("mouseover", function(d){
                d3.select(this).attr("fill", hovercolor)
               tooltip.style("background-color", lightgray) //background
               tooltip.html(d.title + "<br>"+d.code+", "+d.sponsor+", Room: "+d.room)
                return tooltip.style("visibility","visible");})

            //positioning of tooltip
            .on("mousemove", function(d){
                return tooltip
                .style("top",(d3.event.pageY-10)+"px")
                .style("left",(d3.event.pageX+10)+"px");})

            //hide tooltip
            .on("mouseout", function(d){
                refreshCalendarColor()
                return tooltip.style("visibility", "hidden");});

            // DAYS
            svg.selectAll("text.days")
                    .data(days)
                    .enter()
                .append("text")
                .attr("x", 10)
                .attr("y", function(d, i){
                    return (r1+(i+1)*3*bh+10*i);}) //algorithmatic 6, 9, 12, 15bh
                .style("text.anchor", "left")
                .style("font-size", "80px")
                .attr("fill", "black")
                .style("cursor", "pointer")
                //font-family: 'Open Sans';
                .style("font-family","Oxygen Mono")
                //.style("font-family", "monospace")
                .text(function(d){return d.d;})
                .on("click", function(d,i){
                    //deal with the clicked day
                    if(!d.isToggled){
                        d.isToggled = true
                        d3.select(this).attr("fill", "black")
                        ;}
                    else {d.isToggled = false
                        d3.select(this).attr("fill", medgray)
                        ;}

                   //revise the colors of the times
                   d3.selectAll(".calendartimes").attr("fill", function(d)
                        {
                            //get the day associated with this time
                            daysindex = simpledays.indexOf(d.d)
                            if (days[daysindex].isToggled){
                                return "black";
                            }
                            else {
                                return medgray;
                            }
                        })

                   refreshCalendarColor()

                   });

            // TIMES
            svg.selectAll("text.times")
                    .data(times)
                    .enter()
                .append("text")
                .attr("class", "calendartimes")
                .attr("x", 70)
                .attr("y", function(d, i){
                    return (r1 + (i+1)*bh + d3.round(i/3-.5,0)*10 );})
                .attr("fill", "black")
             .style("font-family", "Open Sans")
                .style("text.anchor", "left")
                .style("font-size", "20px")
                .style("cursor", "pointer")
                .style("pointer-events", "none")
                .text(function(d){return d.t;})

            // star the invited sessions
             var stars = svg.selectAll("text.stars")
                    .data(dataset)
                    .enter()
                .append("text")
                .style("cursor", "pointer")
                .attr("fill", "white")
                .style("font-size", starfontsize)
                .style("pointer-events", "none")
                .attr("x", function(d){ //placement based on room
                    roomindex = rooms.indexOf(d.room)
                    return 135+22*roomindex;})

                .attr("y", function(d){
                    //day contribution (aligned with bottom of day label in svg)
                    if(d.day=="M"){offset = r1+2*bh}
                    else if(d.day == "Tu"){offset = r1+5*bh+10}
                    else if(d.day == "W"){offset = r1+8*bh+20}
                    else if(d.day == "Th"){offset = r1+11*bh+30}
                    else {offset = r1+14*bh+40}

                    //time contribution (upwards from 2:30)
                    if(d.time==8){detail = 2*bh}
                    else if(d.time==11){detail = bh}
                    else{detail = 0}
                    return offset-detail+bh-2;})

                .text(function(d){
                    if (d.kind=="invited"){
                        return "\u2605";}
                    else{
                        return "";}});

            // dot the focus sessions
             var circles = svg.selectAll("circ")
                    .data(dataset)
                    .enter()
                .append("circle")
                .style("cursor", "pointer")
                .style("pointer-events", "none")
                .attr("fill", "white")
                .style("visibility", function(d){
                    if (d.kind == "focus"){
                        return "visible"}
                    else{return "hidden";};})
                .attr("r", 5)
                .attr("cx", function(d){ //placement based on room
                    roomindex = rooms.indexOf(d.room)
                    return 135+22*roomindex+.5*bw;})
                .attr("cy", function(d){
                    //day contribution (aligned with bottom of day label in svg)
                    if(d.day=="M"){offset = r1+2*bh}
                    else if(d.day == "Tu"){offset = r1+5*bh+10}
                    else if(d.day == "W"){offset = r1+8*bh+20}
                    else if(d.day == "Th"){offset = r1+11*bh+30}
                    else {offset = r1+14*bh+40}

                    //time contribution (upwards from 2:30)
                    if(d.time==8){detail = 2*bh}
                    else if(d.time==11){detail = bh}
                    else{detail = 0}
                    return offset-detail+.5*bh;});

            // angled text, room numbers, no action on click
            svg.selectAll("text.rooms")
                    .data(rooms)
                    .enter()
                .append("text")
                .style("text.anchor", "middle")
                .style("font-size", "20px")
                .attr("fill", "black")
                .style("font-family", "Open Sans")
                .style("cursor", "default")
                .attr("transform", function(d,i){
                    return "translate("+ (22*i+150) +","+(r1-5)+") rotate(-65)";})
                .text(function(d){
                    return d;});


            // warning
            svg.selectAll("text.aster")
                    .data([0])
                    .enter()
                .append("text")
                .attr("x", 820)
                .attr("y", r1+340)
                .attr("fill", "black")
                .style("font-family", "Open Sans")
                .style("text.anchor", "left")
                .style("font-size", "20px")
                .style("cursor", "pointer")
                .style("pointer-events", "none")
                .text("*FSB = Four Seasons Ballroom, MHB = Mile High Ballroom") ;


        ///////////////////////////
        // Itinerary
        //////////////////////////

        //append a 2d data set to the table, and the table just takes care of the rest
        d3.select("body")
            .append("table")
            .attr("class", "itinerary")
            .style("border-collapse", "collapse")
            .style("border", "8px "+medgray+" solid") //outer border
            .style("width","1369px")
            .style("word-wrap", "break-word")
            .style("height","1000px")
            .style("margin-left", margin.left +"px")
            .style("margin-top", "0px")
            .style("margin-bottom", "40px")

            .selectAll("tr") //adding rows
                .data(dataset2)
                .enter().append("tr")
            .selectAll("td")

            .data(function(d){return d;}) //data trick
                .enter().append("td") //adding columns

            .style("table-layout","fixed") //to get words to wrap
            .style("max-width", "200px")
            .style("text-align", function(d,i,j){
                if (i == 0 || j == 0)
                    {return "center"}
                else
                    {return "left"}})
            .style("vertical-align", function(d,i,j){
                if (i == 0 || j == 0)
                    {return "middle"}
                else
                    {return "top"}})
            .style("border", "4px "+ medgray +" solid")
            .style("border-bottom", function(d,i,j) //dividers between days
                {if (j%3==0){return "14px "+medgray+" solid"}})
            .style("padding", "10px")

            .text(function(d,i,j){if (i>-1 && j>-1) {return d;}}) //add the content

            .style("color", function(d,i,j){
                if (i == 0 || j == 0)
                    {return "black"}
                else
                    {return "black"}})
            .style("font-size", function(d,i,j){
                if (i == 0 || j == 0)
                    {return "18pt"}
                else
                    {return "12pt"}})
                 .style("font-family", "Open Sans")
            .style("font-weight", function(d,i,j){
                if (i == 0 && j == 0)
                    {return "bold"}
                else
                    {return "normal"}});

                //footer
                d3.select("body")
                     .append("p")
                     .style("text-align", "center") //to center text CSS
                     .style("width","1374px")
                    .style("font-size", "12pt")
                 .style("font-family", "Open Sans")
                     .style("margin","5px 80px 40px 100px") //CSS style property, top, right, bottom,
                     .html("@RebeccaWPerry</br>rperry@seas.harvard.edu</br>December 31, 2013");

    })//end json load
        </script>
    </body>
</html>
